<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><title data-react-helmet="true">Words, by Garet McKinley</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><style data-styled="beBtMy bAsCaW  cmNUvM eBdzOa" data-styled-version="4.0.0-beta.1">
/* sc-component-id: sc-global-121403002 */
body{background:#fff;margin:0;} code[class*="language-"],pre[class*="language-"]{color:black;background:none;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;} pre[class*="language-"]{position:relative;margin:1.5em 0;border-left:10px solid #F688AD;background-color:#fff;background-size:3em 3em;background-origin:content-box;overflow:visible;padding:0;} code[class*="language"]{max-height:inherit;height:100%;padding:0 1em;display:block;overflow:auto;} :not(pre) > code[class*="language-"]{position:relative;padding:0.2em;border-radius:0.3em;color:#F688AD;display:inline;white-space:normal;} :not(pre) > code[class*="language-"]:after,pre[class*="language-"]:after{right:0.75em;left:auto;-webkit-transform:rotate(2deg);-moz-transform:rotate(2deg);-ms-transform:rotate(2deg);-o-transform:rotate(2deg);-webkit-transform:rotate(2deg);-ms-transform:rotate(2deg);transform:rotate(2deg);} .token.comment,.token.block-comment,.token.prolog,.token.doctype,.token.cdata{color:#7d8b99;} .token.punctuation{color:#5f6364;} .token.property,.token.tag,.token.boolean,.token.number,.token.function-name,.token.constant,.token.symbol,.token.deleted{color:#c92c2c;} .token.selector,.token.attr-name,.token.string,.token.char,.token.function,.token.builtin,.token.inserted{color:#2f9c0a;} .token.operator,.token.entity,.token.url,.token.variable{color:#a67f59;background:rgba(255,255,255,0.5);} .token.atrule,.token.attr-value,.token.keyword,.token.class-name{color:#1990b8;} .token.regex,.token.important{color:#e90;} .language-css .token.string,.style .token.string{color:#a67f59;background:rgba(255,255,255,0.5);} .token.important{font-weight:normal;} .token.bold{font-weight:bold;} .token.italic{font-style:italic;} .token.entity{cursor:help;} .namespace{opacity:0.7;} @media screen and (max-width:767px){pre[class*="language-"]:before,pre[class*="language-"]:after{bottom:14px;box-shadow:none;}} .token.tab:not(:empty):before,.token.cr:before,.token.lf:before{color:#e0d7d1;} pre[class*="language-"].line-numbers{padding-left:0;} pre[class*="language-"].line-numbers code{padding-left:3.8em;} pre[class*="language-"].line-numbers .line-numbers-rows{left:0;} pre[class*="language-"][data-line]{padding-top:0;padding-bottom:0;padding-left:0;} pre[data-line] code{position:relative;padding-left:4em;} pre .line-highlight{margin-top:0;}
/* sc-component-id: Wrapper-d38xv4-0 */
.bAsCaW{padding:0 0 2em 0;margin:2em 0;border-bottom:1px solid rgba(0,0,0,0.15);}
/* sc-component-id: Wrapper-gu2lg3-0 */
.beBtMy{position:relative;margin:0 auto;max-width:640px;}
/* sc-component-id: Wrapper__Post-sc-1yq5zpi-0 */
.cmNUvM pre{max-width:100%;} .cmNUvM h1{margin-top:0;} .cmNUvM a{-webkit-text-decoration:none;text-decoration:none;text-shadow:0.03em 0 #fff,-0.03em 0 #fff,0 0.03em #fff,0 -0.03em #fff,0.06em 0 #fff,-0.06em 0 #fff,0.09em 0 #fff,-0.09em 0 #fff,0.12em 0 #fff,-0.12em 0 #fff,0.15em 0 #fff,-0.15em 0 #fff;background-image:linear-gradient(#fff,#fff),linear-gradient(#fff,#fff), linear-gradient(#F688AD,#F688AD);background-size:0.05em 2px,0.05em 2px,2px 2px;background-repeat:no-repeat,no-repeat,repeat-x;background-position:0 90%,100% 90%,0 90%;color:#1d1d1d !important;} .cmNUvM blockquote{border-color:#F688AD;}
/* sc-component-id: Wrapper-fjt2wr-0 */
.eBdzOa{max-width:100%;margin:0 auto;margin-top:0px;margin-bottom:0px;text-transform:uppercase;font-style:italic;color:rgb(150,150,150);display:block;margin-top:0px;margin-bottom:5px;font-weight:bolder;font-size:14px;}</style><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.5625 'Source Sans Pro',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Source Sans Pro',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;color:hsla(0,0%,0%,1);font-family:'Source Serif Pro',sans-serif;font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;color:hsla(0,0%,0%,1);font-family:'Source Serif Pro',sans-serif;font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;color:hsla(0,0%,0%,1);font-family:'Source Serif Pro',sans-serif;font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;color:hsla(0,0%,0%,1);font-family:'Source Serif Pro',sans-serif;font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;color:hsla(0,0%,0%,1);font-family:'Source Serif Pro',sans-serif;font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;color:hsla(0,0%,0%,1);font-family:'Source Serif Pro',sans-serif;font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}ul{margin-left:1.5625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.5625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;font-size:0.85rem;line-height:1.5625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;font-size:1rem;line-height:1.5625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}blockquote{margin-left:0;margin-right:1.5625rem;margin-top:0;padding-bottom:0;padding-left:1.75781rem;padding-right:0;padding-top:0;margin-bottom:1.5625rem;font-size:1.1487rem;line-height:1.5625rem;color:hsla(0,0%,0%,0.59);border-left:0.58594rem solid;border-color:#fcea0e;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.5625rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5625rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.5625rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.5625rem;margin-bottom:calc(1.5625rem / 2);margin-top:calc(1.5625rem / 2);}li > ul{margin-left:1.5625rem;margin-bottom:calc(1.5625rem / 2);margin-top:calc(1.5625rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.5625rem / 2);}code{font-size:0.85rem;line-height:1.5625rem;}kbd{font-size:0.85rem;line-height:1.5625rem;}samp{font-size:0.85rem;line-height:1.5625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.04167rem;padding-right:1.04167rem;padding-top:0.78125rem;padding-bottom:calc(0.78125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#F688AD;text-decoration:none;}a:hover,a:active{color:hsla(0,0%,0%,0.8);}h1,h2,h3,h4,h5,h6{margin-top:3.125rem;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.5625rem;color:hsla(0,0%,0%,0.8);font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){blockquote{margin-left:-1.17188rem;margin-right:0;border-left:0.29297rem solid;border-color:#fcea0e;padding-left:0.87891rem;}}</style><link href="//fonts.googleapis.com/css?family=Source+Serif+Pro:600|Source+Sans+Pro:400,400i,700" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/0-fa0e4bb97f1d6dc5caa8.js"/><link as="script" rel="preload" href="/component---src-templates-singlepost-js-2e03e38fe93fd4a2079c.js"/><link as="script" rel="preload" href="/app-1f54e023dfda14193957.js"/><link as="script" rel="preload" href="/webpack-runtime-28857537c0db4799d49f.js"/><link rel="preload" href="/static/d/465/path---posts-btsync-monit-752-927-48VaqIVaVgRh7wB0IwssaTYq4eE.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="Wrapper-gu2lg3-0 beBtMy"><div class="Wrapper-d38xv4-0 bAsCaW"><div><h1 style="margin:0"><a href="/">Words, by Garet McKinley</a></h1></div></div><div class="Wrapper__Post-sc-1yq5zpi-0 cmNUvM"><div><time dateTime="20 January, 2015" class="Wrapper-fjt2wr-0 eBdzOa">20 January, 2015</time></div><h1>Monitoring BitTorrent Sync with Monit on Ubuntu 14.04 LTS</h1><div><p>Over the past few days, I've been doing tons of DevOps work. Lots of setting up server monitoring, security, and automation. Most recently I wanted to give monit a try, as I've heard some good things about it. I was able to install it and get it up and running pretty hassle-free. I added in a few process checks for nginx, php-fpm, and postgres and it instantly was able to start tracking those processes for me.</p>
<p>If you've gone through some of my other posts, you might remember a guide that I wrote about settings up BitTorrent Sync on a remote server, well today I'm going to expand on that a bit and add BitTorrent sync into my monit checks!</p>
<p>There were multiple apparent walls that I was going to run into, as BitTorrent sync wasn't exactly written to be placed on a web server, so it lacks a few things like PID logging and the ability to start/stop the service. In order to overcome this, I figured the wisest approach would be to write a wrapper for the btsync program that would enable stop/start.</p>
<p>If you're unsure what a PID is and why it's important, read on; otherwise, skip the next section and get into the meat of this tutorial.</p>
<h2>What is a PID?</h2>
<p>A PID is a process id. Have you ever run <code class="language-text">top</code> or <code class="language-text">ps aux</code> on your system? If so, you've probably seen a list with rows like this</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root      4038  8.9  4.8 144436 49100 ?        Ssl  15:22   0:17 /BTSync/btsync</code></pre>
      </div>
<p>The number that is in the PID column is obviously the PID. These are unique identifiers for a single process. This unique PID can be used to kill or restart a process. I find that a lot of linux newbies often end up calling <code class="language-text">killall btsync</code> if they wish to kill the process called <code class="language-text">btsync</code>, but this isn't the proper way to do it, as there could be multiple instances of the btsync process. You should only use <code class="language-text">killall</code> if you with to kill multiple processes at once. Like <code class="language-text">killall nginx</code> to stop nginx and all child nodes.</p>
<p>Killing based on PID is much more precise. If we wish to kill the above BitTorrent sync process, we would just use <code class="language-text">kill -KILL 4038</code>. The problem here is that the PID is unique, so upon starting back up, it would have changed.</p>
<p>The way around this, is most programs log the PID inside a file. Typically the PID file would be something like <code class="language-text">/var/run/nginx.pid</code> and it would contain nothing but the PID.</p>
<p>You'd then be able to use the contents of that file to kill or restart your process. Something along the lines of</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">$ kill -HUP $(cat /var/run/nginx.pid)</code></pre>
      </div>
<p>could be used to restart the nginx process.</p>
<p>As I said above, by default BitTorrent sync doesn't log the PID in a file, so it's up to us to fix that.</p>
<h2>The Meat</h2>
<p>I opened up a new file with vim (my personal favorite CLI text editor)</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">$ vim /usr/local/bin/btsync</code></pre>
      </div>
<p>Then I wrote the following script in it</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">#!/bin/bash
if [[ $1 = &quot;start&quot; ]]; then
    /BTSync/btsync --config /BTSync/sync.conf 2&gt;/dev/null &amp; PID=$!
    PID=$(($PID+1))
    echo $PID &gt; /var/run/btsync.pid
elif [[ $1 = &quot;stop&quot; ]]; then
    kill -KILL $(cat /var/run/btsync.pid)
elif [[ $1 = &quot;restart&quot; ]]; then
    kill -HUP $(cat /var/run/btsync.pid)
else
    echo &quot;Invalid option. Use either start, stop, or restart.&quot;
fi</code></pre>
      </div>
<p>If the script feels a little hack-y, that's because it is. For some reason upon starting btsync and retrieving the PID, it was always 1 behind the actual PID. So if it started with a PID of 420 it would end up logging 419 to the <code class="language-text">/var/run/btsync.pid</code> file. Strange, but I have other things I need to get done today, so doing a little bash-fu I was able to log the correct PID to the btsync.pid file. If it wasn't already obvious, you're also going to have to replace <code class="language-text">/BTSync/btsync</code> with the actual location of the binary. If you followed my previous guide for setting it up, then you can leave it as <code class="language-text">/BTSync/btsync</code>.</p>
<p>The next step is making the wrapper an executable. This is easily done by running</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">$ chmod +x /usr/local/bin/btsync</code></pre>
      </div>
<p>Great.</p>
<p>So now we get to add in our check to the <code class="language-text">monitor</code> file. It's been more than easy to add in checks so far, so I expected nothing less when adding in another check for btsync.</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">$ vim /etc/monit/monitrc</code></pre>
      </div>
<p>I then added in the check like so</p>
<div class="gatsby-highlight" data-language="text">
      <pre class="language-text"><code class="language-text">check process btsync with PIDfile /var/run/btsync.pid
    group utilities
    start program = &quot;/usr/local/bin/btsync start&quot;
    stop program = &quot;/usr/local/bin/btsync stop&quot;
    restart program = &quot;/usr/local/bin/btsync restart&quot;</code></pre>
      </div>
<p>After that, I ran a <code class="language-text">monit reload</code> and it started monitoring btsync immediately! I was also able to click on the process and use monit's GUI to stop/start/restart the process.</p></div><div><p>Thanks for reading,</p><p>—Garet</p></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-singlepost-js","jsonName":"posts-btsync-monit-752","path":"/posts/btsync-monit/"};window.dataPath="465/path---posts-btsync-monit-752-927-48VaqIVaVgRh7wB0IwssaTYq4eE";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":"/app-1f54e023dfda14193957.js","component---node-modules-gatsby-plugin-offline-app-shell-js":"/component---node-modules-gatsby-plugin-offline-app-shell-js-9481f4ed47e03ce0fbf2.js","component---src-templates-singlepost-js":"/component---src-templates-singlepost-js-2e03e38fe93fd4a2079c.js","component---src-pages-404-js":"/component---src-pages-404-js-b36d73cc08538606d60a.js","component---src-pages-about-js":"/component---src-pages-about-js-891e1acffa763f673581.js","component---src-pages-contact-js":"/component---src-pages-contact-js-8942b1395d881fc160b4.js","component---src-pages-index-js":"/component---src-pages-index-js-925d85459b462e991b2c.js"};/*]]>*/</script><script src="/webpack-runtime-28857537c0db4799d49f.js" async=""></script><script src="/app-1f54e023dfda14193957.js" async=""></script><script src="/component---src-templates-singlepost-js-2e03e38fe93fd4a2079c.js" async=""></script><script src="/0-fa0e4bb97f1d6dc5caa8.js" async=""></script></body></html>